#include "common.h"
#include <stdalign.h>
#include "EC_add_HW_ASM.h"
#include "montMul_HW_ASM.h"
#include "CoDesign.h"
#include "ecdsa_types.h"


int main() {

  init_platform();
  init_performance_counters(0);
  
  // xil_printf("Starting CoDesign Testbench\n\r");

  // alignas(128) uint32_t res[32];

  // memset(res, 0, sizeof(res));

  // alignas(128) uint32_t a[32] = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xa6406fa0, 0x53b70b21, 0x7cfe76c5, 0x99ba8b73, 0x83e65e9f, 0xdbb2359b, 0xe02744b5, 0x55bb2472, 0xab497843, 0x6521470d, 0x1eb3060a, 0x2ed06caf};
  // alignas(128) uint32_t b[32] = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xc079ee40, 0xd2afdb66, 0xe108c354, 0x80ba5847, 0x9aa08423, 0x1df7c26f, 0x59a67341, 0xafa40f30, 0xfe7de07a, 0xd3fbd0bb, 0x0387b2af, 0x00977f0e};
  // //alignas(128) uint32_t res[32] = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0551eb20, 0xcf1d6929, 0xf12e3720, 0x0b73ca5f, 0xbda44e34, 0x33c07d77, 0xb9bd2607, 0x27d8cd55, 0x65e463fc, 0x91d843ae, 0x4a81c428, 0x2f8583e9};

  // xil_printf("Starting Montgomery Multiplication HW Test\n\r");
  // START_TIMING
  // montMul_HW_ASM(a, b, res);
  // STOP_TIMING
  // xil_printf("Montgomery Multiplication Result:\n\r");
  // print_array_contents("result", res);
  // START_TIMING
  // montMul_HW_ASM(a, b, res);
  // STOP_TIMING

  // xil_printf("Montgomery Multiplication Result:\n\r");
  // print_array_contents("result", res);

  // alignas(128) EC_point_t P =        { .X = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000008, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},
  //                                      .Y = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000010, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000}, 
  //                                      .Z = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000018, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000} };

  // alignas(128) EC_point_t Q =        { .X = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000008, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},
  //                                      .Y = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000010, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000}, 
  //                                      .Z = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000018, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000} };
  // alignas(128) EC_point_t R;

  // memset(&R, 0, sizeof(EC_point_t));
  
  // START_TIMING
  // EC_add_HW_ASM(&P, &Q, &R);
  // EC_add_HW_ASM(&P, &Q, &R); // Second call to see consistent results
  // STOP_TIMING
  // xil_printf("EC Point Addition Result:\n\r");
  // print_array_contents("R.X", R.X);
  // print_array_contents("R.Y", R.Y);
  // print_array_contents("R.Z", R.Z);

  alignas(128) uint32_t message[32]   = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0259f288, 0xff51387e, 0x7ec8d3fe, 0x5a65e59f, 0xe3d2fe18, 0xb37f6b53, 0xe9d354f2, 0x85c0ae96, 0x00000002, 0x00000000, 0x00000000, 0x00000000};       
                                                                                       
  // Signature K and s         
  alignas(128) uint32_t K_X[32]       = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xac378fd0, 0x28f98829, 0x5140aec3, 0xb5048e19, 0x07124bea, 0x5e8bfc74, 0x702f5d97, 0xc7fe1c4c, 0xef0c6e29, 0x0660e9b5, 0x2745d20c, 0x11ccb5fa};          
  alignas(128) uint32_t K_Y[32]       = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xda6bdf90, 0x23a8a482, 0x06c27b16, 0x0cbb8284, 0xdc623e93, 0x5c5f19e4, 0x5faec492, 0xc6fa839c, 0x4ef18f66, 0xd34e3f31, 0xc3130c3c, 0x804bf30c};          
  alignas(128) uint32_t K_Z[32]       = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x5c96d600, 0x852f4d15, 0x67b09ed2, 0x97f69beb, 0x5bedb31e, 0xb2aa3a04, 0x5c906880, 0xd1c7e5e1, 0xde3192a5, 0x16e907e1, 0x919f135e, 0xc79e31bc};          
  EC_point_t K = { .X = K_X, .Y = K_Y, .Z = K_Z };
  alignas(128) uint32_t s[32]         = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x24a64420, 0xa186a2ed, 0xf7b9cb60, 0xf4670b41, 0xf618eb69, 0x6c5c2aa9, 0x9cc3d97c, 0xb7600dd3, 0x00000002, 0x00000000, 0x00000000, 0x00000000};             
  signature_t signature = { .K = K, .s = s };
                                                                                        
  // Public key                                                                          
  alignas(128) uint32_t Public_X[32]  = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xa2f5e608, 0x82870fe2, 0xcf727478, 0x7a1ec66e, 0xf3214f63, 0x0f4102a2, 0xe45624a8, 0x46e21127, 0xacd05523, 0xedc3c7cb, 0x6bcb560b, 0x46590dc7}; 
  alignas(128) uint32_t Public_Y[32]  = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x336e9f70, 0x02b3cc1f, 0xba951023, 0xaf18db90, 0x6620e457, 0x25723d1d, 0x878b8a4f, 0x256e6329, 0x421c5515, 0x6d38af9e, 0xb9c87b19, 0xae6017a6}; 
  alignas(128) uint32_t Public_Z[32]  = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x4710c2b8, 0xb58c1d41, 0x9a3b49b2, 0x149961fc, 0xe6f48603, 0x830564e1, 0x50abff30, 0xc24b9cda, 0x3c814ab1, 0xfd98b650, 0x5f994238, 0x832a85af}; 
  EC_point_t PublicKey = { .X = Public_X, .Y = Public_Y, .Z = Public_Z };
                                                                                        
  // // OUTPUT VALUES final                                                                 
  // alignas(128) uint32_t C_X[32]       = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xfcd29530, 0x21dfe4bc, 0x641adae3, 0x2de992d7, 0xdec73d0c, 0x404570f6, 0xd8904a92, 0xbb78f902, 0x3f66edfa, 0x20882ead, 0xc48ac2cf, 0x7ded7afc};          
  // alignas(128) uint32_t C_Y[32]       = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x1409da08, 0x2222d474, 0x19bbb575, 0xf2320fda, 0xc30fe0e4, 0x3ca41db5, 0x661af613, 0x4ebf6b87, 0xef080012, 0x7e3091de, 0xce227964, 0x1d6ee2d2};          
  // alignas(128) uint32_t C_Z[32]       = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x346d4ce8, 0xb756bf9f, 0x4637bad1, 0x1897835d, 0x5af2c5f4, 0x9e6afa9d, 0x45745352, 0xdd95bd38, 0x714bc4f4, 0x17d0b119, 0xcc5368b0, 0x4507e81e};          
  // alignas(128) uint32_t C_Prime_X[32] = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xa36017f8, 0xd563a6e4, 0xfed10aca, 0x79052aa6, 0x2d30e816, 0xf27cf990, 0x617eb804, 0x932acb6b, 0xfec9ded2, 0x5b623160, 0xde3bc5a8, 0xcc6bcbb7};    
  // alignas(128) uint32_t C_Prime_Y[32] = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x03ad9338, 0xcf4318ef, 0x20108c13, 0x2391ef87, 0x7e428d01, 0x4aca000a, 0x7b45983c, 0xc52ac1c0, 0xeb9f482f, 0x922925ef, 0xe6a86697, 0x6f081340};    
  // alignas(128) uint32_t C_Prime_Z[32] = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x54462e30, 0xc70f080e, 0x4530d320, 0x766ca27c, 0x541bcaac, 0xdf719552, 0x755723f6, 0xb16f20a7, 0x3f4696a6, 0x3f332a87, 0x08ea0094, 0x0bde3992};    
                                                                                        
  //START POINT ON CURVE                                                                                       
  alignas(128) uint32_t G_X[32]       = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xd91635d8, 0xd9d78056, 0xcbd0d77f, 0x62af41ff, 0xb8dd62c3, 0x0a71d1f8, 0xbba5c82d, 0x1b44627c, 0x7d4d607e, 0x34ab1c62, 0x8cbebca1, 0xbf8e9d39};          
  alignas(128) uint32_t G_Y[32]       = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x362f3f08, 0x6551194a, 0x14445720, 0x81e63a25, 0x60259f6e, 0x06d8c659, 0xae8057b0, 0xe7af04ae, 0xa0ec5727, 0x04f1876b, 0x1d55078d, 0x459fa40f};          
  alignas(128) uint32_t G_Z[32]       = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000008, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000};          
  EC_point_t G = { .X = G_X, .Y = G_Y, .Z = G_Z };
                                                                                        
  alignas(128) uint32_t K_X_Modn[32]  = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x50c7a4a8, 0xa9765f0a, 0xd7296da4, 0x633fb2a5, 0x7e2e7fd7, 0x2176a8f6, 0x9082f474, 0xbc8e9338, 0x00000002, 0x00000000, 0x00000000, 0x00000000};             

  xil_printf("Starting ECDSA Signature Verification...\n\r");
  START_TIMING
  verify_ecdsa(message, &signature, &PublicKey, &G, K_X_Modn);
  STOP_TIMING

  xil_printf("ECDSA Signature Verification Completed.\n\r");

  cleanup_platform();

  return 0;
}


